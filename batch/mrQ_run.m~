function mrQ_run(mrQ,clobber)
%mrQ_run(RawDir,arrangeRawFlag,SEIR_seriesNumbers,SPGR_seriesNumbers,refIm,sub,freesurfer,channels,useNiftiFlag,alignFlag,complexFlag,useAbs,mmPerVox,interp,skip,coilWeights,clobber)
% mrQ_run(RawDir,arrangeRawFlag,SEIR_seriesNumbers,SPGR_seriesNumbers,refIm,sub,freesurfer,channels,useNiftiFlag,alignFlag,complexFlag,useAbs,mmPerVox,interp,skip,coilWeights,clobber)
%
% # a batch call to run all the mrQ fits in one click
% # the batch  run over mrQ functions to claculate the maps (T1,PD TV WF
% SIR) it will also run Ants SGE and freesurfer softwhere. all of those and
%%the mrVista reposotorry must be set and updated
%
% INPUT VARIABLES of the structure:
%   RawDir            - The path of the directory containing the raw MR
%                       data.the function assume the data are arrange in the same way as it is in the Stanford CNI magnet.
%                       the data should be saved as niifti files and a dicom directory with dicom are also exist.
%                       This convention may be different for each scanner.
%                       It is good idea to cheack this and maybe arrange the data with this conventions or edit the first function that call the raw directory ( mrQ_arrangeData.m)
%
%   arangeRawFlag     - Needs to be 1 to move every file from the original
%                       magnet directory (dataDir) to a raw directory
%                       inside it (if this was done set = 0, or empty).
%
%   SEIR_seriesNumbers- A cell array containing the SEIR_epi series numbers
%                       from dataDir/raw.  (if this input exists a SEIR dir
%                       will be created with data and fitT1_GS directories
%                       inside it). The scan dicom will be extracted from
%                       the data Dir. If SEIR_epi already exists and a new
%                       one will be created.
%
%   SPGR_seriesNumbers- A cell array with the SPGR series numbers from
%                       dataDir/raw. This input creates a SPGR directory
%                       with data inside it. The scan dicom will be
%                       extracted from the data Dir. If SPGR already exists
%                       a new one will be created.
%
%  refImg              Different ref images can be used as an input (refImg is a
%                      path to a nifti image). If there is no refImg (refImg is
%                      empty) then the SPGR with a similar contrast to the T1
%                      weighted image will be selected and the user will be
%                      asked to mark the ac/pc using mrAnatAverageAcpcNifti
%
%       sub            - Subject name used for different file names
%                       like the SGE. if the name is not porvided we will take it for the
%                        raw directory
%
%   freesurfer         -an exssisting freesurfer segmentation aparc+aseg in
%                       nii.gz format. if this is not provied then freesurfer segmentation on a
%                       syntetic T1w image that we will calculate from the data. or on the refImg if it been provided. the freesurfer
%                       segmentation may take 24 hours. freesurfer segmentation may failed and
%                       the user need to cheack if it is.
%
%   channels          - A 1xN array (where N is the number of series). If
%                       any of the SPGR data has multi-channel dicoms make
%                       the series number equal to the number of channels.
%                       The default is zero.
%
%   useNiftiFlag      - A 1xN logical array (where N is the number of
%                       series). If it is set to 1 the code will use the
%                       nii.gz file and the channel variable input is not
%                       used. defult is ones
%
%   alignFlag          - if to align the SEIR data set the defult is 1 (yes).
%
%  complexFlag         - if the SEIR data is complex and not only magnitude the defult is 0 (no).
%
%   useAbs              -if the SEIR data is complex but only magnitude need to be used defult is 0 (no).
%
%   mmPerVox           - The resolution at which you want to resample the data.
%                        This is a 3X1 (1x3?) vector. If empty, the dicom
%                        resolution will be used-this does not have to be the
%                        native scan size as the magnet output % is zeroed. The
%                        saved directory will have the resolution in its name.
%
%  interp              -Interpolation method. [Default = 1]
%                       1 = trilinear,
%                       7 = b-spline (resampling algorithm)
%
%  skip                -you can skip any of the scans in spgrDir if you want by
%                       passing in a 1xn vector of scans to skip.
%
%  coilWeights         -determine optimal coil weights and save them out.
%                       Default = true; when we use more then 8 chanels
%                       coils
%
%  clobber              -Overwrite existing data and reprocess. [default = false]
%
%
%output % save a mrQparm file the document the anaysis. the different file
%make fiels and directory. the run end when a map directory with five map
%is crated including T1 WF TV SIR and VIP maps file
%
%Example :
%
%RawDir='/biac2/wandell2/data/WMDevo/adult/133_KK/QuantativeImaging/20120308_2002';
%SEIR_seriesNumbers={'0005' '0006' '0007' '0008'};
%SPGR_seriesNumbers={'0010' '0011' '0012' '0013'};
%
%mrQ_run(RawDir,[],SEIR_seriesNumbers,SPGR_seriesNumbers,[],'133_KK')
%
%examples:
%RawDir=/biac2/wandell2/data/WMDevo/adult/108_AM/QuantitativeImaging/20111020_1297_8ch_1mm3
% SEIR_seriesNumbers={'0005' '0006' '0007' '0008'};
%SPGR_seriesNumbers ={'0009' '0010' '0011' '0012'}
%channels= [32 32 32 32]


%useNiftiFlag      - A 1xN logical array (where N is the number of
%                       series). If it is set to 1 the code will use the
%                       nii.gz file and the channel variable input is not
%                       used. *** WHY USE THIS OR DON'T? ***
%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% param for the mrQ_arrangeData

if ~isfield(mrQ,'RawDir')
    disp('Raw data need to be provided');
    error
end;


if ~isfield(mrQ,'SPGR_seriesNumbers')
    mrQ.SPGR_seriesNumbers=[];
end

% this wwill use te nii.gz file and not the dicom in the SPGR dir
% (should be the defult if they avilable.
if ~isfield(mrQ,'useNiftiFlag')
    mrQ.useNiftiFlag(1:length(mrQ.SPGR_seriesNumbers))=1;
end

sub=mrQ.sub;



%% for T1 fit

%%
%% arange data form the magnet

% most subject have this allready, we need to check before we run it should
% come form the user


if isfield(mrQ,'Arange_Date')
    
    fprintf([ '\n  using data intiate at ' mrQ.Arange_Date ' !  \n']);
    
else
    fprintf('\n  aranging the data\n  ')
    [mrQ]=  mrQ_arrangeData(mrQ.RawDir,mrQ.arrangeRawFlag,mrQ.SEIR_seriesNumbers,mrQ.SPGR_seriesNumbers,mrQ.channels,mrQ.useNiftiFlag,mrQ);
    fprintf('arange data is done - done!');
    save(mrQ.name,'mrQ');
end



%% fit SEIR
%load(name); %we load the SEIR dir that was saved by mrQ_arrangeData before


if isfield(mrQ,'SEIR_done');
else
    mrQ.SEIR_done=0;
end


if (mrQ.SEIR_done==0);
    
    %keep track of the variable we use  for detail see inside the function
    [~, ~, ~, mrQ.SEIRsaveData]=mrQ_initSEIR(mrQ.SEIRepiDir,mrQ.alignFlag,mrQ.complexFlag,mrQ.useAbs);
    
    [mrQ]=mrQ_fitSEIR_T1(mrQ.SEIRepiDir,[],[],0,mrQ);
    mrQ.SEIR_done=1;
    save(mrQ.name,'mrQ');
    fprintf('fit SEIR  - done!');
    
else
    fprintf('\n  load fit SEIR data ! \n');
    
end


%% intiate and  Alighn SPGR
%  param for Alighn SPGR



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%load(name);

if isfield(mrQ,'SPGR_init');
else
    mrQ.SPGR_init=0;
end

if     mrQ.SPGR_init==0
    
    %keep track of the variable we use  for detail see inside the function
    
    [~, ~, ~,~,~, mrQ]=mrQ_initSPGR(mrQ.SPGR,mrQ.refIm,mrQ.mmPerVox,mrQ.interp,mrQ.skip,[],mrQ);
    mrQ.SPGR_init=1;
    
    save(mrQ.name,'mrQ');
    fprintf('\n  init SPGR - done!           \n');
else
    fprintf(' \n load init SPGR data            \n');
    
end
%% Save out a data structure with the optimal coil weighting applied



if isfield(mrQ,'SPGR_coilWeight');
else
    mrQ.SPGR_coilWeight=0;
end



if  (mrQ.coilWeights==1 && mrQ.coilNum(1)>8  && mrQ.SPGR_coilWeight==0)
    
    fprintf('\n Determining optimal coil weighting...\n');
    % Should this return the new structure with the weighting applied?
    mrQ_multicoilWeighting(mrQ.spgr_initDir,mrQ.SPGR_niiFile,mrQ.SPGR_niiFile_FA);
    mrQ.SPGR_coilWeight=1;
    fprintf('\n SPGR  coil weighting - done!               \n');
    
else
    
end
save(mrQ.name,'mrQ');





%% %% Fit SPGR PD

if isfield(mrQ,'SPGR_T1fit');
else
    mrQ.SPGR_T1fit=0;
end

%vclover is implamented inside (we canadd rthis to the inputs
if (mrQ.SPGR_T1fit==0);
    [mrQ.AnalysisInfo]=mrQfit_T1M0_ver2(mrQ);
    mrQ.SPGR_T1fit=1;
    
    save(mrQ.name,'mrQ');
    fprintf('\n fit T1 SPGR  - done!              \n');
else
    fprintf('\n load fited  SPGR T1                \n');
    
end
save(mrQ.name,'mrQ');


%
% if we plan to run the freesurfer as part of the batch then a good time to
% do it is after mrQ_T1wSynthesis.m  is done (line 357 in mrQfit_T1M0_ver2). this function crate the T1
% wighted image that can be used as an input for freesurfer.




%% prefer to PD fit 1. get a segmentation (need freesurfer output) 2. get CSF; 3.make a M0 fies for the coils

%1. segmentaion
if isfield(mrQ,'segmentaion');
else
    mrQ.segmentaion=0;
end

if mrQ.segmentaion==0;
    if (mrQ.runfreesurfer==1)
        
        mrQ=mrQ_Complitfreesurfer(mrQ);
        mrQ.segmentaion=1;
    else
        % Segment the T1w by FSL (step 1) and get the tissue mask (CSF WM GM) (step 2)
        mrQ=mrQ_segmentT1w2tissue(mrQ);
        mrQ.segmentaion=1;
        
    end
    save(mrQ.name,'mrQ');
end

%3. coils MO
if isfield(mrQ,'calM0');
else
    mrQ.calM0=0;
end

if (mrQ.calM0==0);
    fprintf('\n calculate M0 for each coil               \n');
    
    %build a multi coil M0 image for the coils raw data and then fitted T1
    [mrQ.M0combineFile]=mrQ_multicoilM0(mrQ.spgr_initDir,[],[],mrQ.SPGR_niiFile,mrQ.SPGR_niiFile_FA);
    mrQ.calM0=1;
    save(mrQ.name,'mrQ');
else
    fprintf('\n load M0 of each coil               \n');
    
end

%

%% fit PD

if isfield(mrQ,'SPGR_PDfit');
else
    mrQ.SPGR_PDfit=0;
end


  if mrQ.SPGR_PDfit==0;
    fprintf('\n calculate PD from the M0 of all the coil               \n');
    
    %we hard code the number of poylonomyal to 3 see details inside the
    %functions
    mrQ.PolyDeg=3;
    %send the a call for the grid to fit  PD
    [mrQ.opt]=mrQ_fitPD_multicoil(mrQ.spgr_initDir,1,[],mrQ.PolyDeg,mrQ.sub);
    
    %check for GE before you move on
    mrQ.SPGR_PDfit=1;
    save(mrQ.name,'mrQ');
else
    fprintf('\n load the  claculted PD from the coils  M0               \n');
    
end




% bild the grid PD fits
if isfield(mrQ,'SPGR_PDBuild');
    %we need a check for the GE
else
    mrQ.SPGR_PDBuild=0;
end

if (mrQ.SPGR_PDBuild==0 && mrQ.SPGR_PDfit==1)
    fprintf('build the WF map               ');
    
    
    [mrQ.PDcombineInfo]=mrQ_BuildCoilsfitsPD(mrQ.spgr_initDir);
    mrQ.SPGR_PDfit=1;
    save(mrQ.name,'mrQ');
else
    fprintf('load the WF map               ');
    
end
%calculate VIP TV and SIR

if (mrQ.SPGR_PDfit==1)
    fprintf('\n calculate VIP TV SIR form T1 and WF maps               \n');
    
    [mrQ.AnalysisInfo]=mrQ_VIP(mrQ.spgr_initDir);
    save(mrQ.name,'mrQ');
end

%% last orgnized the brain maps in a directory named maps
fprintf('\n orgenized the maps in a maps directory                \n');

mapDir=fullfile(mrQ.spgr_initDir,'maps');
mkdir(mapDir);
%eval(['! mv ' Dir{i} '/* '  name '/.']) ;

cmd =(['! mv ' mrQ.spgr_initDir '/T1_map_lsq.nii.gz ' mapDir '/.']) ;
eval(cmd);

cmd =(['! mv ' mrQ.spgr_initDir '/WF_map.nii.gz ' mapDir '/.']) ;
eval(cmd);

cmd =(['! mv ' mrQ.spgr_initDir '/VIP_map.nii.gz ' mapDir '/.']) ;
eval(cmd);

cmd =(['! mv ' mrQ.spgr_initDir '/TV_map.nii.gz ' mapDir '/.']) ;
eval(cmd);

cmd =(['! mv ' mrQ.spgr_initDir '/SIR_map.nii.gz ' mapDir '/.']) ;
eval(cmd);

mrQ.mapsDir=mapDir;
mrQ.maps.T1path=fullfile(mapDir,'T1_map_lsq.nii.gz');
mrQ.maps.WFpath=fullfile(mapDir,'WF_map.nii.gz');
mrQ.maps.TVpath=fullfile(mapDir,'TV_map.nii.gz');
mrQ.maps.SIRpath=fullfile(mapDir,'SIR_map.nii.gz');

%done
mrQ.AnalysisDwon=1;
mrQ.AnalysisDwonDate=date;
%save
save(mrQ.name,'mrQ');
fprintf('\n done !!! \n')
%%